<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STL 3D 아스키 뷰어 (인터랙티브 버전)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: "Press Start 2P", "Tahoma", sans-serif;
            background-color: #008080;
            color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
            box-sizing: border-box;
            font-size: 12px;
        }
        .window {
            background-color: #c0c0c0;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #808080;
            border-bottom: 2px solid #808080;
            box-shadow: 1px 1px 0px #000000;
            width: 100%;
            max-width: 800px;
            padding: 3px;
        }
        .title-bar {
            background: linear-gradient(to right, #000080, #1084d0);
            color: #ffffff;
            padding: 5px 6px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .window-body {
            padding: 1rem;
        }
        p {
            margin-top: 0;
            line-height: 1.5;
        }
        #ascii-output {
            font-family: "Courier New", Courier, monospace;
            white-space: pre;
            background-color: #000000;
            padding: 0.5rem;
            border: 2px inset #808080;
            overflow: hidden;
            cursor: grab;
            height: 350px; 
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #ascii-output:active {
            cursor: grabbing;
        }
        .placeholder {
            color: #888;
        }
        fieldset {
            border: 2px groove #c0c0c0;
            padding: 1rem;
            margin-top: 1rem;
        }
        legend {
            padding: 0 0.5rem;
        }
        .controls-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .control-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        button, select {
            font-family: "Press Start 2P", "Tahoma", sans-serif;
            font-size: 12px;
            background-color: #c0c0c0;
            color: #000000;
            padding: 8px 12px;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #808080;
            border-bottom: 2px solid #808080;
            cursor: pointer;
            text-align: center;
        }
        button:active {
            border-top: 2px solid #808080;
            border-left: 2px solid #808080;
            border-right: 2px solid #ffffff;
            border-bottom: 2px solid #ffffff;
        }
    </style>
</head>
<body>

    <div class="window">
        <div class="title-bar">
            <span>STL 3D ASCII Viewer</span>
        </div>
        <div class="window-body">
            <p>아래 컨트롤러로 모델을 제어해보세요.</p>
            
            <div id="ascii-output">
                <div class="placeholder">모델 로딩 중...</div>
            </div>

            <div class="controls-container">
                <fieldset>
                    <legend>모델 컨트롤</legend>
                    <div class="control-group">
                        <button id="toggle-rotation-btn">회전 정지</button>
                        <div class="control-item">
                            <label for="rotation-speed-slider">속도:</label>
                            <input type="range" id="rotation-speed-slider" min="0" max="50" value="10">
                        </div>
                        <div class="control-item">
                            <label for="zoom-slider">줌:</label>
                            <input type="range" id="zoom-slider" min="20" max="300" value="100">
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>렌더링 설정</legend>
                    <div class="control-group">
                        <div class="control-item">
                            <label for="charset-select">문자:</label>
                            <select id="charset-select">
                                <option value="detailed">상세</option>
                                <option value="simple">단순</option>
                                <option value="blocks">블록</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label for="resolution-slider">해상도:</label>
                            <input type="range" id="resolution-slider" min="4" max="14" value="10">
                        </div>
                        <button id="invert-colors-btn">색상 반전</button>
                    </div>
                </fieldset>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 기본 요소 ---
            const asciiOutput = document.getElementById('ascii-output');
            const toggleRotationBtn = document.getElementById('toggle-rotation-btn');
            const rotationSpeedSlider = document.getElementById('rotation-speed-slider');
            const zoomSlider = document.getElementById('zoom-slider');
            const charsetSelect = document.getElementById('charset-select');
            const resolutionSlider = document.getElementById('resolution-slider');
            const invertColorsBtn = document.getElementById('invert-colors-btn');

            // --- 상태 변수 ---
            let scene, camera, renderer, mesh, animationFrameId;
            let isAutoRotating = true, rotationSpeed = 0.01, isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            let lastUpdateTime = 0;
            const updateInterval = 100;

            // --- 설정 변수 ---
            const CHAR_SETS = {
                detailed: '`^\",:;Il!i~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$',
                simple: ' .:-=+*#%@',
                blocks: ' ░▒▓█'
            };
            let currentAsciiChars = CHAR_SETS.detailed;
            let modelColor = '#87CEFA', bgColor = '#333', sceneBgColor = 0x000000;
            
            // ===================================================================
            // *** 여기에 본인의 GitHub Raw URL을 붙여넣으세요. ***
            // ===================================================================
            const defaultStlUrl = 'https://raw.githubusercontent.com/nowyees/page/main/basic%20model.stl';

            // --- Three.js 초기화 및 리셋 ---
            function initThree() {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(sceneBgColor);
                camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                renderer = new THREE.WebGLRenderer();
                updateRendererSize();
                resetCamera();
            }
            
            function resetCamera() {
                if(camera) camera.position.z = 100;
                zoomSlider.value = 100;
            }
            
            function updateRendererSize() {
                if (!asciiOutput) return;
                const fontSize = parseInt(resolutionSlider.max) + parseInt(resolutionSlider.min) - parseInt(resolutionSlider.value);
                const lineHeight = fontSize;
                asciiOutput.style.fontSize = `${fontSize}px`;
                asciiOutput.style.lineHeight = `${lineHeight}px`;
                const charWidth = fontSize * 0.6, charHeight = lineHeight;
                if (charWidth <= 0 || charHeight <= 0) return;
                const containerWidth = asciiOutput.clientWidth, containerHeight = asciiOutput.clientHeight;
                const renderWidth = Math.floor(containerWidth / charWidth);
                const renderHeight = Math.floor(containerHeight / charHeight);
                if (renderer) renderer.setSize(renderWidth, renderHeight);
                if (camera) {
                    camera.aspect = renderWidth / renderHeight;
                    camera.updateProjectionMatrix();
                }
            }

            // --- STL 로드 및 처리 ---
            async function loadModelFromUrl(url) {
                const placeholder = document.querySelector('.placeholder');
                if(placeholder) placeholder.textContent = "URL에서 로딩 중...";
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP 오류! 상태: ${response.status}`);
                    const data = await response.arrayBuffer();
                    processSTL(data);
                } catch (error) {
                    console.error("URL 로드 실패:", error);
                    if(placeholder) placeholder.textContent = "오류: URL 로드 실패";
                }
            }

            function processSTL(contents) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (!scene) initThree();
                while(scene.children.length > 0) scene.remove(scene.children[0]); 
                asciiOutput.style.display = 'block';
                asciiOutput.style.textAlign = 'left';

                const loader = new THREE.STLLoader();
                const geometry = loader.parse(contents);
                geometry.center();
                const material = new THREE.MeshNormalMaterial();
                mesh = new THREE.Mesh(geometry, material);
                const box = new THREE.Box3().setFromObject(mesh);
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 100 / maxDim;
                mesh.scale.set(scale, scale, scale);
                scene.add(mesh);
                resetCamera();
                animate(0);
            }

            // --- 컨트롤 이벤트 리스너 ---
            toggleRotationBtn.addEventListener('click', () => {
                isAutoRotating = !isAutoRotating;
                toggleRotationBtn.textContent = isAutoRotating ? '회전 정지' : '회전 시작';
            });
            rotationSpeedSlider.addEventListener('input', (e) => { rotationSpeed = e.target.value / 1000; });
            zoomSlider.addEventListener('input', (e) => { if (camera) camera.position.z = e.target.value; });
            charsetSelect.addEventListener('change', (e) => { currentAsciiChars = CHAR_SETS[e.target.value]; });
            resolutionSlider.addEventListener('input', updateRendererSize);
            invertColorsBtn.addEventListener('click', () => {
                [modelColor, bgColor] = [bgColor, modelColor];
                sceneBgColor = (sceneBgColor === 0x000000) ? 0xffffff : 0x000000;
                scene.background = new THREE.Color(sceneBgColor);
                asciiOutput.style.backgroundColor = (sceneBgColor === 0x000000) ? '#000000' : '#ffffff';
            });
            asciiOutput.addEventListener('mousedown', (e) => { isDragging = true; previousMousePosition = { x: e.clientX, y: e.clientY }; });
            document.addEventListener('mouseup', () => { isDragging = false; });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging || !mesh) return;
                const deltaMove = { x: e.clientX - previousMousePosition.x, y: e.clientY - previousMousePosition.y };
                mesh.rotation.y += deltaMove.x * 0.01;
                mesh.rotation.x += deltaMove.y * 0.01;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            // --- 렌더링 ---
            function renderToAscii() {
                if (!renderer || !scene || !camera) return;
                renderer.render(scene, camera);
                const gl = renderer.getContext();
                const width = gl.drawingBufferWidth, height = gl.drawingBufferHeight;
                if (width === 0 || height === 0) return;
                const pixels = new Uint8Array(width * height * 4);
                gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
                let htmlString = '';
                const brightnessThreshold = sceneBgColor === 0x000000 ? 10 : 245;
                for (let y = height - 1; y >= 0; y--) {
                    for (let x = 0; x < width; x++) {
                        const offset = (y * width + x) * 4;
                        const brightness = (pixels[offset] + pixels[offset + 1] + pixels[offset + 2]) / 3;
                        const charIndex = Math.floor((brightness / 255) * (currentAsciiChars.length - 1));
                        const char = currentAsciiChars[charIndex] || ' ';
                        const isModel = sceneBgColor === 0x000000 ? brightness > brightnessThreshold : brightness < brightnessThreshold;
                        if (isModel) {
                            htmlString += `<span style="color: ${modelColor};">${char}</span>`;
                        } else {
                            htmlString += `<span style="color: ${bgColor};">${char}</span>`;
                        }
                    }
                    htmlString += '\n';
                }
                asciiOutput.innerHTML = htmlString;
            }

            // --- 최적화된 애니메이션 루프 ---
            function animate(currentTime) {
                animationFrameId = requestAnimationFrame(animate);
                if (mesh && isAutoRotating && !isDragging) {
                    mesh.rotation.y += rotationSpeed;
                }
                if (currentTime - lastUpdateTime > updateInterval) {
                    renderToAscii();
                    lastUpdateTime = currentTime;
                }
            }

            // --- 페이지 로드 시 기본 모델 불러오기 ---
            loadModelFromUrl(defaultStlUrl);
        });
    </script>
</body>
</html>
