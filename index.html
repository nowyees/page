<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STL 3D 아스키 뷰어 (윈도우 98 테마)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <style>
        body {
            font-family: "Tahoma", "Verdana", "Arial", sans-serif;
            background-color: #008080; /* 클래식 윈도우 배경색 */
            color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .window {
            background-color: #c0c0c0; /* 윈도우 기본 회색 */
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #808080;
            border-bottom: 2px solid #808080;
            box-shadow: 1px 1px 0px #000000;
            width: 100%;
            max-width: 800px;
            padding: 3px;
        }
        .title-bar {
            background: linear-gradient(to right, #000080, #1084d0); /* 타이틀바 그라데이션 */
            color: #ffffff;
            padding: 4px 6px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .window-body {
            padding: 1rem;
        }
        p {
            margin-top: 0;
        }
        input[type="file"] {
            display: none;
        }
        .file-label, button {
            background-color: #c0c0c0;
            color: #000000;
            padding: 8px 16px;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #808080;
            border-bottom: 2px solid #808080;
            cursor: pointer;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        .file-label:active, button:active {
            border-top: 2px solid #808080;
            border-left: 2px solid #808080;
            border-right: 2px solid #ffffff;
            border-bottom: 2px solid #ffffff;
        }
        #file-name {
            margin-top: 1rem;
            padding: 0.5rem;
            border: 2px inset #808080;
            background-color: #ffffff;
            min-height: 1.2em;
        }
        #ascii-output {
            font-family: "Courier New", Courier, monospace;
            white-space: pre;
            background-color: #000000;
            padding: 1rem;
            border: 2px inset #808080;
            overflow: auto;
            font-size: 10px;
            line-height: 7px;
            text-align: left;
            cursor: grab;
        }
        #ascii-output:active {
            cursor: grabbing;
        }
        .placeholder {
            color: #888;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
        }
        fieldset {
            border: 2px groove #c0c0c0;
            padding: 1rem;
            margin: 1rem 0;
        }
        legend {
            padding: 0 0.5rem;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        .control-group label {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <div class="window">
        <div class="title-bar">
            <span>STL 3D ASCII Viewer</span>
        </div>
        <div class="window-body">
            <p>STL 파일을 선택하고 모델을 제어해보세요.</p>
            
            <label for="stl-file-input" class="file-label">파일 찾기...</label>
            <input type="file" id="stl-file-input" accept=".stl">
            <div id="file-name">선택된 파일 없음</div>
            
            <fieldset>
                <legend>컨트롤</legend>
                <div class="control-group">
                    <button id="toggle-rotation-btn">회전 정지</button>
                </div>
                <div class="control-group">
                    <label for="rotation-speed-slider">회전 속도:</label>
                    <input type="range" id="rotation-speed-slider" min="0" max="50" value="10">
                </div>
                <div class="control-group">
                    <label for="zoom-slider">확대/축소:</label>
                    <input type="range" id="zoom-slider" min="20" max="300" value="100">
                </div>
            </fieldset>

            <div id="ascii-output">
                <div class="placeholder">파일을 업로드하여 3D 모델을 확인하세요.</div>
            </div>
        </div>
    </div>

    <script>
        // --- 기본 요소 및 상태 변수 ---
        const fileInput = document.getElementById('stl-file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const asciiOutput = document.getElementById('ascii-output');
        const toggleRotationBtn = document.getElementById('toggle-rotation-btn');
        const rotationSpeedSlider = document.getElementById('rotation-speed-slider');
        const zoomSlider = document.getElementById('zoom-slider');

        const ASCII_CHARS = '`^\",:;Il!i~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$';
        
        let scene, camera, renderer, mesh;
        let animationFrameId;

        // 컨트롤 상태 변수
        let isAutoRotating = true;
        let rotationSpeed = 0.01;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        // --- Three.js 초기화 ---
        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000); // 배경을 검은색으로 변경
            const renderWidth = 120, renderHeight = 80;
            camera = new THREE.PerspectiveCamera(75, renderWidth / renderHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(renderWidth, renderHeight);
            resetCamera();
        }
        
        function resetCamera() {
            if(camera) camera.position.z = 100;
            zoomSlider.value = 100;
        }

        // --- 파일 처리 ---
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                fileNameDisplay.textContent = '선택된 파일 없음';
                return;
            }
            fileNameDisplay.textContent = `파일: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => loadSTL(e.target.result);
            reader.readAsArrayBuffer(file);
        });

        // --- STL 로드 ---
        function loadSTL(contents) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (!scene) initThree();
            while(scene.children.length > 0) scene.remove(scene.children[0]); 

            const loader = new THREE.STLLoader();
            const geometry = loader.parse(contents);
            const material = new THREE.MeshNormalMaterial();
            mesh = new THREE.Mesh(geometry, material);

            const box = new THREE.Box3().setFromObject(mesh);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 100 / maxDim;

            mesh.position.sub(center);
            mesh.scale.set(scale, scale, scale);
            scene.add(mesh);
            
            resetCamera();
            animate();
        }

        // --- 컨트롤 이벤트 리스너 ---
        toggleRotationBtn.addEventListener('click', () => {
            isAutoRotating = !isAutoRotating;
            toggleRotationBtn.textContent = isAutoRotating ? '회전 정지' : '회전 시작';
        });

        rotationSpeedSlider.addEventListener('input', (e) => {
            rotationSpeed = e.target.value / 1000;
        });

        zoomSlider.addEventListener('input', (e) => {
            if (camera) camera.position.z = e.target.value;
        });

        // 마우스 드래그로 회전
        asciiOutput.addEventListener('mousedown', (e) => {
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging || !mesh) return;
            const deltaMove = {
                x: e.clientX - previousMousePosition.x,
                y: e.clientY - previousMousePosition.y
            };

            mesh.rotation.y += deltaMove.x * 0.01;
            mesh.rotation.x += deltaMove.y * 0.01;

            previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // --- 렌더링 및 애니메이션 ---
        function renderToAscii() {
            if (!renderer || !scene || !camera) return;
            renderer.render(scene, camera);
            const gl = renderer.getContext();
            const width = gl.drawingBufferWidth, height = gl.drawingBufferHeight;
            const pixels = new Uint8Array(width * height * 4);
            gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);

            // HTML 문자열을 만들어 한 번에 innerHTML을 설정 (성능 최적화)
            let htmlString = '';
            for (let y = height - 1; y >= 0; y--) {
                for (let x = 0; x < width; x++) {
                    const offset = (y * width + x) * 4;
                    const brightness = (pixels[offset] + pixels[offset + 1] + pixels[offset + 2]) / 3;
                    const charIndex = Math.floor((brightness / 255) * (ASCII_CHARS.length - 1));
                    const char = ASCII_CHARS[charIndex];
                    
                    // 밝기 임계값을 기준으로 모델과 배경을 구분
                    if (brightness > 10) { // 배경이 완전 검은색이므로 임계값을 낮춤
                        htmlString += `<span style="color: #87CEFA;">${char}</span>`; // 모델 부분: 파란색
                    } else {
                        htmlString += `<span style="color: #333;">${char}</span>`; // 배경 부분: 어두운 회색
                    }
                }
                htmlString += '\n';
            }
            asciiOutput.innerHTML = htmlString;
        }

        function animate() {
            animationFrameId = requestAnimationFrame(animate);
            if (mesh && isAutoRotating && !isDragging) {
                mesh.rotation.y += rotationSpeed;
            }
            renderToAscii();
        }
    </script>
</body>
</html>
